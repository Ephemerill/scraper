<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Biola Wizard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />

    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon" />
</head>

<body class="bg-dark">

<i class="bi bi-gear-fill" id="settings-icon"
   data-bs-toggle="modal" data-bs-target="#settingsModal"
   title="Settings"></i>

<div class="container pt-5">
  <h1 class="text-center text-light mb-4">Biola Wizard</h1>

  <div class="main-content-container">

    <div class="d-flex justify-content-between align-items-center">
      <h2 class="text-secondary" id="current-time">Loading time…</h2>
      <h2 class="text-secondary">
        {% if weather and weather["temperature"] and weather["temperature"][0] %}
            {{ weather["temperature"][0]["temperature"] }}
        {% else %} --°F {% endif %}
      </h2>
    </div>

    <hr class="my-2" style="border-color:#a9a9a9;border-width:2px;">

    <div class="tab-content mt-3" id="menuTabsContent">
        {% for meal_key, meal_name in {"breakfast":"Breakfast","lunch":"Lunch","dinner":"Dinner"}.items() %}
        <div class="tab-pane fade" id="{{ meal_key }}" role="tabpanel" aria-labelledby="{{ meal_key }}-tab">
          <h2>{{ meal_name }} Menu:</h2>
          {% if menu and menu[meal_key] %}
            {% for station in menu[meal_key] %}
              {# --- STATION WRAPPER for easier targeting --- #}
              <div class="station-block mb-3"> 
                <div class="d-flex align-items-center mb-1">
                  <h3 class="mb-0">{{ station.name | title }}</h3>
                  <button class="btn btn-outline-secondary btn-sm ms-2 station-action-button"
                          type="button" 
                          title="Get Info for {{ station.name | title }}"> {# Updated title #}
                    <i class="bi bi-info-circle"></i> 
                  </button>
                </div>
                
                <ul class="list-unstyled ms-4 station-meal-list"> {# Added class #}
                    {% set sidx = loop.index0 %}
                    {% for option in station.options %}
                      {% set did = "desc-" ~ meal_key ~ "-" ~ sidx ~ "-" ~ loop.index0 %}
                      {% set mid = "meal-" ~ meal_key ~ "-" ~ sidx ~ "-" ~ loop.index0 %} {# Unique ID for the meal item #}
                      
                      <li class="mb-2" {# Increased bottom margin slightly #}
                          id="{{ mid }}"
                          data-meal-name="{{ option.meal | title }}" 
                          data-meal-desc="{{ option.description | default('', true) }}"> 
                        
                        {# Meal Name and Description Button (if applicable) #}
                        <div class="d-flex align-items-center"> {# Wrap name and button for alignment #}
                            <span class="meal-title me-2">{{ option.meal | title }}</span>
                            {% if option.description %}
                            <button class="btn btn-link p-0 ms-1 align-baseline toggle-desc"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#{{ did }}"
                                    aria-expanded="false"
                                    aria-controls="{{ did }}">
                                <i class="bi bi-chevron-down small"></i>
                            </button>
                            {% endif %}
                        </div>

                        {# Description Collapsible Div (only if description exists) #}
                        {% if option.description %}
                        <div class="collapse" id="{{ did }}">
                            <small class="text-muted d-block ps-3 pt-1">{{ option.description }}</small>
                        </div>
                        {% endif %}

                        {# --- RATING AREA (Now outside description collapse) --- #}
                        <div class="rating-area ps-3 pt-1 d-flex align-items-center">
                            <div class="stars-display me-2">
                            {# Static display - could be updated later if needed #}
                            <i class="bi bi-star text-muted"></i>
                            <i class="bi bi-star text-muted"></i>
                            <i class="bi bi-star text-muted"></i>
                            <i class="bi bi-star text-muted"></i>
                            <i class="bi bi-star text-muted"></i>
                            <span class="rating-avg-text ms-1 text-muted small">(No ratings yet)</span> 
                            </div>
                            <button class="btn btn-outline-primary btn-sm rate-meal-btn" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#ratingModal"
                                    data-meal-name="{{ option.meal | title }}"
                                    title="Rate {{ option.meal | title }}">
                            <i class="bi bi-pencil-square"></i> Rate
                            </button>
                        </div>
                        {# --- END RATING AREA --- #}

                      </li>
                    {% endfor %}
                  </ul>
                  {# --- Placeholder for the dynamic response --- #}
                  <div class="station-response-box ms-4"></div> 
              </div> {# --- End STATION WRAPPER --- #}
            {% endfor %}
          {% else %}
            <p>{{ meal_name }} menu not available.</p>
          {% endif %}
        </div>
        {% endfor %}
      </div>

    <ul class="nav nav-tabs mt-2" id="menuTabs" role="tablist">
      {% for meal_key, meal_name in {"breakfast":"Breakfast","lunch":"Lunch","dinner":"Dinner"}.items() %}
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="{{ meal_key }}-tab"
                data-bs-toggle="tab" data-bs-target="#{{ meal_key }}"
                type="button" role="tab"
                aria-controls="{{ meal_key }}" aria-selected="false">
          {{ meal_name }}
        </button>
      </li>
      {% endfor %}
    </ul>

    <hr class="thick-hr">

    <div id="chat-section-wrapper">
       </div>

  </div></div><div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ratingModalLabel" style="color:#333;">Rate Meal</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="color:#333;">
        <p>How would you rate <strong id="modal-meal-name">this meal</strong>?</p>
        {# Ensure stars are easily selectable #}
        <div class="rating-stars-interactive mb-3 text-center" data-current-rating="0"> 
          <i class="bi bi-star rating-star mx-1" data-value="1"></i>
          <i class="bi bi-star rating-star mx-1" data-value="2"></i>
          <i class="bi bi-star rating-star mx-1" data-value="3"></i>
          <i class="bi bi-star rating-star mx-1" data-value="4"></i>
          <i class="bi bi-star rating-star mx-1" data-value="5"></i>
        </div>
        <input type="hidden" id="rating-meal-name-hidden" value="">
        <div id="rating-feedback" class="text-danger small mt-2 text-center"></div> 
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitRatingBtn">Submit Rating</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1"
     aria-labelledby="settingsModalLabel" aria-hidden="true">
    </div>

<div class="text-center personal-toggle-item">
    </div>

<p class="text-center text-secondary disclaimer">...</p>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("DOMContentLoaded event fired. Starting script execution.");

  /* -------- helpers -------- */
  // ... (Keep setCookie, getCookie as before) ...
  window.setCookie = function(n, v, d) { /* ... */ };
  window.getCookie = function(n) { /* ... */ };
  console.log("Helper functions defined.");

  /* -------- clock -------- */
  const timeElement = document.getElementById("current-time");
  console.log("Time element found:", timeElement ? "Yes" : "No");
  function displayTime() { /* ... Keep working displayTime function ... */ }
  console.log("displayTime function defined.");

  /* -------- auto‑select meal tab -------- */
  // ... (Keep working auto-select tab logic with try-catch) ...
  console.log("Tab selection logic executed.");

  /* -------- caret rotation (Revised Logic) -------- */
  // ... (Keep revised caret rotation logic using Bootstrap events) ...
  console.log("Caret rotation listeners attached.");

  /* -------- settings toggles -------- */
  // ... (Keep working settings toggle logic with try-catch) ...
  console.log("Settings toggles initialized.");

  /* -------- chat arrow -------- */
  // ... (Keep working chat arrow logic with try-catch) ...
   console.log("Chat arrow listener attached.");

  /* -------- chat send -------- */
  // ... (Keep working chat send logic with try-catch) ...
  console.log("Chat send listeners attached.");

  /* -------- Station‑response logic -------- */
  // ... (Keep working station response logic with try-catch) ...
  console.log("Station response listeners attached.");


  // ==================================================
  //           ⭐ RATING SYSTEM LOGIC (Focus on Interaction) ⭐
  // ==================================================
  try {
      const ratingModalElement = document.getElementById('ratingModal');
      const ratingModal = ratingModalElement ? new bootstrap.Modal(ratingModalElement) : null;
      const modalMealNameElement = document.getElementById('modal-meal-name');
      const modalHiddenMealNameInput = document.getElementById('rating-meal-name-hidden');
      const interactiveStarsContainer = ratingModalElement?.querySelector('.rating-stars-interactive');
      const interactiveStars = interactiveStarsContainer?.querySelectorAll('.rating-star'); // NodeList
      const submitRatingBtn = document.getElementById('submitRatingBtn');
      const ratingFeedback = document.getElementById('rating-feedback');
      const ratingEndpoint = '/rate';

      console.log("Rating Elements Check: Modal:", !!ratingModalElement, "Bootstrap Modal Instance:", !!ratingModal, "Stars Container:", !!interactiveStarsContainer, "Stars Found:", interactiveStars ? interactiveStars.length : 0, "Submit Button:", !!submitRatingBtn);

      // --- Helper Functions for Stars ---
      function setStars(rating) {
          console.log(`--- setStars called with rating: ${rating} (Type: ${typeof rating}) ---`);
          if (!interactiveStarsContainer || !interactiveStars || interactiveStars.length === 0) {
              console.warn("setStars: Could not find stars to update.");
              return; // Stop if no stars found
          }

          const numericRating = parseInt(rating, 10);
          if (isNaN(numericRating)) {
              console.error("setStars: Invalid rating value after parseInt:", rating);
              return; // Stop if not a number
          }

          // Store the validated numeric rating in the dataset
          interactiveStarsContainer.dataset.currentRating = numericRating;
          console.log(`Dataset 'data-current-rating' updated to: ${interactiveStarsContainer.dataset.currentRating}`);

          interactiveStars.forEach(star => {
              const starValue = parseInt(star.dataset.value, 10); // Ensure base 10
              if (isNaN(starValue)) return; // Skip invalid stars

              // Perform comparison and update classes/styles
              if (starValue <= numericRating) {
                  // Fill the star
                  star.classList.remove('bi-star');
                  star.classList.add('bi-star-fill');
                  star.style.color = '#ffc107'; // Gold
              } else {
                  // Empty the star
                  star.classList.remove('bi-star-fill');
                  star.classList.add('bi-star');
                  star.style.color = '#ccc'; // Grey
              }
          });
          console.log("--- setStars finished ---");
      }

      // hoverStars function definition (keep if using hover effects)
       function hoverStars(rating) { /* ... from previous ... */ }


      // --- Event Listeners for Modal Stars ---
      // Ensure this block only runs if stars were actually found
      if (interactiveStarsContainer && interactiveStars && interactiveStars.length > 0) {

          interactiveStars.forEach(star => {
              star.addEventListener('click', (event) => {
                  event.stopPropagation(); // Good practice
                  const clickedValue = star.dataset.value;
                  console.log(`⭐ Star clicked! Value read from dataset: ${clickedValue}`);

                  // Call setStars to update internal state and visual appearance
                  setStars(clickedValue);

                  // Clear feedback message when a star is clicked
                  if (ratingFeedback) ratingFeedback.textContent = '';
              });

              // Add hover listeners if desired
              // star.addEventListener('mouseover', () => { hoverStars(parseInt(star.dataset.value, 10)); });
          });

          // Add mouseleave listener if hover is used
          // interactiveStarsContainer.addEventListener('mouseleave', () => { setStars(interactiveStarsContainer.dataset.currentRating); });

          console.log("✅ Attached CLICK listeners to rating stars.");

      } else {
          console.error("❌ Could not attach rating star listeners: Stars not found.");
      }


      // --- Event Listener for Opening the Modal ---
      if (ratingModalElement && ratingModal) {
          ratingModalElement.addEventListener('show.bs.modal', (event) => {
              console.log("--- Modal 'show.bs.modal' event ---");
              const button = event.relatedTarget;
              if (!button) return;
              const mealName = button.getAttribute('data-meal-name');
              console.log(`Modal opening for: ${mealName}`);

              if (modalMealNameElement) modalMealNameElement.textContent = mealName;
              if (modalHiddenMealNameInput) modalHiddenMealNameInput.value = mealName;

              // Reset state visually and internally
              setStars(0); // Important: Reset rating state AND visual stars
              if (ratingFeedback) ratingFeedback.textContent = '';
              if (submitRatingBtn) submitRatingBtn.disabled = false; // Default to enabled

              // Check if rated and adjust UI accordingly
              const storageKey = `rated_${mealName}`;
              const isRated = localStorage.getItem(storageKey) === 'true';
              console.log(`Checking if rated (${storageKey}): ${isRated}`);

              const elementsToDisable = interactiveStars ? Array.from(interactiveStars) : []; // Convert NodeList to Array if needed
              if (submitRatingBtn) elementsToDisable.push(submitRatingBtn); // Add submit button to the list

              elementsToDisable.forEach(el => {
                  if (!el) return; // Skip if element is null
                  if (isRated) {
                      el.style.pointerEvents = 'none';
                      el.style.opacity = '0.6';
                      if (el.tagName === 'BUTTON') el.disabled = true; // Specifically disable button too
                  } else {
                      el.style.pointerEvents = 'auto';
                      el.style.opacity = '1';
                       if (el.tagName === 'BUTTON') el.disabled = false; // Ensure button is enabled
                  }
              });

              if (isRated && ratingFeedback) {
                  ratingFeedback.textContent = 'You have already rated this item.';
              }
              console.log("--- Modal state reset and checked ---");
          });
          console.log("✅ Attached 'show.bs.modal' listener.");
      } else {
          console.error("❌ Could not attach modal 'show' listener: Modal element or instance missing.");
      }


      // --- Event Listener for Submitting the Rating ---
      if (submitRatingBtn && modalHiddenMealNameInput && interactiveStarsContainer) {
          submitRatingBtn.addEventListener('click', async () => {
              console.log("--- Submit button clicked ---");

              const mealName = modalHiddenMealNameInput.value;
              // Read the CURRENT rating value from the container's dataset
              const rating = parseInt(interactiveStarsContainer.dataset.currentRating || '0', 10);

              console.log(`Attempting submission for: '${mealName}', Rating: ${rating}`);

              const storageKey = `rated_${mealName}`;

              // **Validation 1: Rating selected?**
              if (rating === 0) {
                  console.warn("Submission aborted: Rating is 0.");
                  if (ratingFeedback) ratingFeedback.textContent = 'Please select a star rating (1-5).';
                  return; // Stop execution
              }

              // **Validation 2: Already rated?** (Check localStorage again)
              if (localStorage.getItem(storageKey) === 'true') {
                  console.warn("Submission aborted: Item already marked as rated in localStorage.");
                  if (ratingFeedback) ratingFeedback.textContent = 'You have already rated this item.';
                  submitRatingBtn.disabled = true; // Ensure it stays disabled
                  return; // Stop execution
              }

              // If validations pass, proceed with submission
              submitRatingBtn.disabled = true;
              if (ratingFeedback) ratingFeedback.textContent = 'Submitting...';
              console.log("Validation passed. Sending fetch request...");

              try {
                  const response = await fetch(ratingEndpoint, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ meal_name: mealName, rating: rating }),
                  });

                  if (!response.ok) {
                      // Try to get error message from response body
                      let errorMsg = `Server error: ${response.status} ${response.statusText}`;
                      try {
                          const errorData = await response.json();
                          errorMsg = errorData.message || errorMsg;
                      } catch (e) { /* Ignore if response not JSON */ }
                      throw new Error(errorMsg);
                  }

                  const result = await response.json();
                  console.log("Fetch response status:", result.status);

                  if (result.status === 'success') {
                      console.log("Rating successfully submitted via fetch.");
                      localStorage.setItem(storageKey, 'true'); // Mark as rated NOW

                      // Update the original button(s) on the page
                      document.querySelectorAll(`.rate-meal-btn[data-meal-name="${mealName}"]`).forEach(originalButton => {
                          originalButton.disabled = true;
                          originalButton.innerHTML = '<i class="bi bi-check-lg"></i> Rated';
                          originalButton.title = 'You have already rated this item';
                      });

                      if (ratingFeedback) ratingFeedback.textContent = 'Rating submitted!';
                      if (ratingModal) ratingModal.hide(); // Close modal

                  } else {
                      // Handle specific failure message from backend
                      throw new Error(result.message || 'Submission failed (unknown reason).');
                  }

              } catch (error) {
                  console.error('❌ Rating submission fetch/processing error:', error);
                  if (ratingFeedback) ratingFeedback.textContent = `Error: ${error.message}. Please try again.`;
                  // Only re-enable button if it wasn't successfully rated (check storage again)
                  if (localStorage.getItem(storageKey) !== 'true') {
                      submitRatingBtn.disabled = false;
                  }
              }
          });
          console.log("✅ Attached CLICK listener to submit button.");
      } else {
          console.error("❌ Could not attach submit listener: Button, hidden input, or stars container missing.");
      }

      // Definition of disableRatedButtonsOnLoad remains same
       window.disableRatedButtonsOnLoad = function() { /* ... from previous ... */ }

  } catch (e) {
      console.error("❌ Error during Rating System setup:", e);
  }


  /* -------- kick things off -------- */
  // ... (Keep working kick things off block with try-catch and logging) ...
  console.log("Entering final initialization block (kick things off)...");
   try {
      console.log("Attempting initial displayTime call...");
      displayTime(); // Initial call
      console.log("Initial displayTime call successful.");

      console.log("Attempting setInterval for displayTime...");
      window.intervalId = setInterval(displayTime, 60_000);
      console.log("setInterval for displayTime successful. Interval ID:", window.intervalId);

      console.log("Attempting disableRatedButtonsOnLoad call...");
      if (typeof disableRatedButtonsOnLoad === 'function') {
          disableRatedButtonsOnLoad();
          console.log("disableRatedButtonsOnLoad call completed.");
      } else {
          console.error("disableRatedButtonsOnLoad function is not defined when called.");
      }

      console.log("✅ Biola Wizard JS Loaded Successfully ✅"); // Final confirmation

  } catch (error) {
      console.error("❌ Error during final initialization (kick things off):", error);
  }

}); // End of DOMContentLoaded
</script>

</body>
</html>