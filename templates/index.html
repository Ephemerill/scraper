<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biola Wizard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    </head>

<body class="bg-dark">

    <i class="bi bi-gear-fill" id="settings-icon" data-bs-toggle="modal" data-bs-target="#settingsModal" title="Settings"></i>

    <div class="container pt-5"> <h1 class="text-center text-light mb-4">Biola Wizard 1.0</h1>
        <div class="main-content-container">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="text-secondary" id="current-time">Loading time...</h2>
                <h2 class="text-secondary">
                    {% if weather and weather['temperature'] and weather['temperature'][0] %}
                        {{ weather['temperature'][0]['temperature'] }}
                    {% else %}
                        --Â°F
                    {% endif %}
                </h2>
            </div>
            <hr class="my-2" style="border-color: #a9a9a9; border-width: 2px;">

            <div class="tab-content mt-3" id="menuTabsContent">
                <div class="tab-pane fade" id="breakfast" role="tabpanel" aria-labelledby="breakfast-tab">
                    <h2>Breakfast Menu:</h2>
                    {% if menu and menu.breakfast %}
                        {% for item in menu.breakfast %}
                            <h3>{{ item.name | title }}</h3>
                            <ul>
                                {% for option in item.options %}
                                    <li>{{ option }}</li>
                                {% endfor %}
                            </ul>
                        {% endfor %}
                    {% else %}
                        <p>Breakfast menu not available.</p>
                    {% endif %}
                </div>
                <div class="tab-pane fade" id="lunch" role="tabpanel" aria-labelledby="lunch-tab">
                    <h2>Lunch Menu:</h2>
                     {% if menu and menu.lunch %}
                        {% for item in menu.lunch %}
                            <h3>{{ item.name | title }}</h3>
                            <ul>
                                {% for option in item.options %}
                                    <li>{{ option }}</li>
                                {% endfor %}
                            </ul>
                        {% endfor %}
                    {% else %}
                        <p>Lunch menu not available.</p>
                    {% endif %}
                </div>
                <div class="tab-pane fade" id="dinner" role="tabpanel" aria-labelledby="dinner-tab">
                    <h2>Dinner Menu:</h2>
                     {% if menu and menu.dinner %}
                        {% for item in menu.dinner %}
                            <h3>{{ item.name | title }}</h3>
                            <ul>
                                {% for option in item.options %}
                                    <li>{{ option }}</li>
                                {% endfor %}
                                </ul>
                        {% endfor %}
                    {% else %}
                        <p>Dinner menu not available.</p>
                    {% endif %}
                </div>
            </div>

            <ul class="nav nav-tabs mt-2" id="menuTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="breakfast-tab" data-bs-toggle="tab" data-bs-target="#breakfast" type="button" role="tab" aria-controls="breakfast" aria-selected="false">Breakfast</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="lunch-tab" data-bs-toggle="tab" data-bs-target="#lunch" type="button" role="tab" aria-controls="lunch" aria-selected="false">Lunch</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="dinner-tab" data-bs-toggle="tab" data-bs-target="#dinner" type="button" role="tab" aria-controls="dinner" aria-selected="false">Dinner</button>
                </li>
            </ul>

            <hr class="thick-hr">

            <div id="chat-section-wrapper">
                <div id="chat-toggle-wrapper">
                    <div id="chat-toggle-button" title="Toggle Chat"></div>
                    <div id="chat-container">
                        <div id="chat-input-area">
                            <input type="text" id="user-input" placeholder="Type your message...">
                            <button id="send-button">Send</button>
                        </div>
                        <div id="chat-messages">
                            </div>
                    </div>
                </div>
            </div>
        </div> </div> <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel" style="color: #333;">Settings</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="color: #333;"> <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="chatVisibilityToggle">
                        <label class="form-check-label" for="chatVisibilityToggle">Show AI Chat Window</label>
                    </div>
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
            </div>
        </div>
    </div>
    <!-- Keep the Bootstrap JS include -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Replace the entire <script> block below with this updated version -->
    <script>
        // --- Time Display Script ---
        function displayTime() {
            // ... (Keep your existing displayTime function exactly as it is) ...
             const now = new Date();
             let hours = now.getHours();
             const minutes = now.getMinutes().toString().padStart(2, '0');
             const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
             const dayOfWeek = daysOfWeek[now.getDay()];
             const period = hours >= 12 ? 'PM' : 'AM';
             hours = hours % 12;
             hours = hours ? hours : 12; // Hour '0' should be '12'
             const currentTime = `${dayOfWeek}, ${hours}:${minutes} ${period}`;
             const timeElement = document.getElementById('current-time');
             if (timeElement) {
                 timeElement.textContent = currentTime;
             }
        }
        // Initial call and interval
        displayTime();
        setInterval(displayTime, 60000); // Update every minute

        // --- Run Scripts after DOM is loaded ---
        document.addEventListener('DOMContentLoaded', function() {

            // --- Tab Activation Logic ---
            // ... (Keep your existing Tab Activation Logic exactly as it is) ...
             const now = new Date();
             const currentHour = now.getHours();
             let currentMealPeriod = 'breakfast'; // Default

             if (currentHour >= 7 && currentHour < 11) { currentMealPeriod = 'breakfast'; }
             else if (currentHour >= 11 && currentHour < 16) { currentMealPeriod = 'lunch'; }
             else if (currentHour >= 16 && currentHour < 20) { currentMealPeriod = 'dinner'; }

             const targetTabButtonId = currentMealPeriod + '-tab';
             const targetPaneId = currentMealPeriod;
             const targetTabButton = document.getElementById(targetTabButtonId);
             const targetPane = document.getElementById(targetPaneId);
             const allTabButtons = document.querySelectorAll('#menuTabs .nav-link');
             const allTabPanes = document.querySelectorAll('#menuTabsContent .tab-pane');

             allTabButtons.forEach(button => {
                 button.classList.remove('active');
                 button.setAttribute('aria-selected', 'false');
             });
             allTabPanes.forEach(pane => {
                 pane.classList.remove('show', 'active');
             });

             if (targetTabButton && targetPane) {
                 targetTabButton.classList.add('active');
                 targetTabButton.setAttribute('aria-selected', 'true');
                 targetPane.classList.add('show', 'active');
             } else {
                  const firstTabButton = document.querySelector('#menuTabs .nav-link');
                  const firstPaneSelector = firstTabButton?.getAttribute('data-bs-target');
                  const firstPane = firstPaneSelector ? document.querySelector(firstPaneSelector) : null;
                  if (firstTabButton && firstPane){
                      firstTabButton.classList.add('active');
                      firstTabButton.setAttribute('aria-selected', 'true');
                      firstPane.classList.add('show', 'active');
                  }
             }

            // --- Chat Messaging Logic ---
            // ... (Keep your existing Chat Messaging Logic exactly as it is) ...
             const chatMessages = document.getElementById('chat-messages');
             const userInput = document.getElementById('user-input');
             const sendButton = document.getElementById('send-button');
             const n8nWebhookUrl = 'https://n8n.biolawizard.com/webhook/ddaed16e-73be-4de6-b3e2-8e246f0765fc'; // <-- REPLACE IF NEEDED

             function addMessage(text, sender) { /* ...keep function content... */ }
             function addErrorMessage(text) { /* ...keep function content... */ }
             async function sendMessage() { /* ...keep function content... */ }

             if (sendButton) sendButton.addEventListener('click', sendMessage);
             if (userInput) userInput.addEventListener('keypress', (event) => { /* ...keep function content... */ });


            // --- Settings and Visibility Control ---
            const chatVisibilityToggle = document.getElementById('chatVisibilityToggle');
            const chatToggleButton = document.getElementById('chat-toggle-button'); // Arrow
            const chatContainer = document.getElementById('chat-container'); // Box
            // Note: chatSectionWrapper is fetched inside applyChatVisibility if needed

            // ***** MODIFIED FUNCTION with new class name *****
            // Function to apply visibility based on the setting
            const applyChatVisibility = (isVisible) => {
                 // Check for the essential toggle switch first
                 if (!chatVisibilityToggle) {
                     console.error("Cannot apply AI visibility: Toggle switch element missing.");
                     return;
                 }
                 // console.log(`Applying visibility: ${isVisible}`); // Debug log

                 // --- Logic for the main Chat Section (assuming it shouldn't have the ai-toggle class) ---
                 const chatSectionWrapper = document.getElementById('chat-section-wrapper');
                 if (chatSectionWrapper) {
                     if (isVisible) {
                         chatSectionWrapper.classList.remove('hidden');
                     } else {
                         chatSectionWrapper.classList.add('hidden');
                         chatToggleButton?.classList.remove('expanded');
                         chatContainer?.classList.remove('expanded');
                     }
                 }

                 // --- Generic Logic for ALL elements marked with the NEW control class ---
                 // ***** Use the new class name 'ai-toggle' here *****
                 const otherToggleableElements = document.querySelectorAll('.ai-toggle');
                 otherToggleableElements.forEach(element => {
                      // No need to check against chat wrapper ID if it won't have the ai-toggle class
                      if (isVisible) {
                         element.classList.remove('hidden');
                     } else {
                         element.classList.add('hidden');
                     }
                 });

                 // --- Update the toggle switch state (always do this) ---
                 chatVisibilityToggle.checked = isVisible;
            };
            // ***** END OF MODIFIED FUNCTION *****


            // --- Initial Load ---
            // Use the same localStorage key 'chatVisible', but apply logic using the modified function
            const savedVisibility = localStorage.getItem('chatVisible') || 'false';
            applyChatVisibility(savedVisibility === 'true');

            // --- Event Listener for the Settings Toggle Switch ---
            // Calls the modified function
            if (chatVisibilityToggle) {
                chatVisibilityToggle.addEventListener('change', function(event) {
                    const isVisible = event.target.checked;
                    applyChatVisibility(isVisible);
                    // Still save using the original key, unless you want separate saved states
                    localStorage.setItem('chatVisible', isVisible ? 'true' : 'false');
                });
            } else {
                console.error("AI visibility toggle switch not found.");
            }

            // --- Event Listener for the Arrow Toggle Button ---
            // This logic remains the same
            if (chatToggleButton && chatContainer) {
                 chatToggleButton.addEventListener('click', function() {
                     const chatSectionWrapper = document.getElementById('chat-section-wrapper');
                     if (chatSectionWrapper && !chatSectionWrapper.classList.contains('hidden')) {
                         const isExpanding = !chatContainer.classList.contains('expanded');
                         chatToggleButton.classList.toggle('expanded', isExpanding);
                         chatContainer.classList.toggle('expanded', isExpanding);
                          if (isExpanding) {
                              userInput?.focus();
                          }
                     }
                 });
             } else {
                 console.error("Chat toggle button or container not found.");
             }

        }); // End DOMContentLoaded
    </script>

</body>
</html>