<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Biola Wizard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />

    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon" />
</head>

<body class="bg-dark">

<i class="bi bi-gear-fill" id="settings-icon"
   data-bs-toggle="modal" data-bs-target="#settingsModal"
   title="Settings"></i>

<div class="container pt-5">
  <h1 class="text-center text-light mb-4">Biola Wizard</h1>

  <div class="main-content-container">

    <div class="d-flex justify-content-between align-items-center">
      <h2 class="text-secondary" id="current-time">Loading time…</h2>
      <h2 class="text-secondary">
        {% if weather and weather["temperature"] and weather["temperature"][0] %}
            {{ weather["temperature"][0]["temperature"] }}
        {% else %} --°F {% endif %}
      </h2>
    </div>

    <hr class="my-2" style="border-color:#a9a9a9;border-width:2px;">

    <div class="tab-content mt-3" id="menuTabsContent">
        {% for meal_key, meal_name in {"breakfast":"Breakfast","lunch":"Lunch","dinner":"Dinner"}.items() %}
        <div class="tab-pane fade" id="{{ meal_key }}" role="tabpanel" aria-labelledby="{{ meal_key }}-tab">
          <h2>{{ meal_name }} Menu:</h2>
          {% if menu and menu[meal_key] %}
            {% for station in menu[meal_key] %}
              {# --- STATION WRAPPER for easier targeting --- #}
              <div class="station-block mb-3"> 
                <div class="d-flex align-items-center mb-1">
                  <h3 class="mb-0">{{ station.name | title }}</h3>
                  <button class="btn btn-outline-secondary btn-sm ms-2 station-action-button"
                          type="button" 
                          title="Get Info for {{ station.name | title }}"> {# Updated title #}
                    <i class="bi bi-info-circle"></i> 
                  </button>
                </div>
                
                <ul class="list-unstyled ms-4 station-meal-list"> {# Added class #}
                    {% set sidx = loop.index0 %}
                    {% for option in station.options %}
                      {% set did = "desc-" ~ meal_key ~ "-" ~ sidx ~ "-" ~ loop.index0 %}
                      {% set mid = "meal-" ~ meal_key ~ "-" ~ sidx ~ "-" ~ loop.index0 %} {# Unique ID for the meal item #}
                      
                      <li class="mb-2" {# Increased bottom margin slightly #}
                          id="{{ mid }}"
                          data-meal-name="{{ option.meal | title }}" 
                          data-meal-desc="{{ option.description | default('', true) }}"> 
                        
                        {# Meal Name and Description Button (if applicable) #}
                        <div class="d-flex align-items-center"> {# Wrap name and button for alignment #}
                            <span class="meal-title me-2">{{ option.meal | title }}</span>
                            {% if option.description %}
                            <button class="btn btn-link p-0 ms-1 align-baseline toggle-desc"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#{{ did }}"
                                    aria-expanded="false"
                                    aria-controls="{{ did }}">
                                <i class="bi bi-chevron-down small"></i>
                            </button>
                            {% endif %}
                        </div>

                        {# Description Collapsible Div (only if description exists) #}
                        {% if option.description %}
                        <div class="collapse" id="{{ did }}">
                            <small class="text-muted d-block ps-3 pt-1">{{ option.description }}</small>
                        </div>
                        {% endif %}

                        {# --- RATING AREA (Now outside description collapse) --- #}
                        <div class="rating-area ps-3 pt-1 d-flex align-items-center">
                            <div class="stars-display me-2">
                            {# Static display - could be updated later if needed #}
                            <i class="bi bi-star text-muted"></i>
                            <i class="bi bi-star text-muted"></i>
                            <i class="bi bi-star text-muted"></i>
                            <i class="bi bi-star text-muted"></i>
                            <i class="bi bi-star text-muted"></i>
                            <span class="rating-avg-text ms-1 text-muted small">(No ratings yet)</span> 
                            </div>
                            <button class="btn btn-outline-primary btn-sm rate-meal-btn" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#ratingModal"
                                    data-meal-name="{{ option.meal | title }}"
                                    title="Rate {{ option.meal | title }}">
                            <i class="bi bi-pencil-square"></i> Rate
                            </button>
                        </div>
                        {# --- END RATING AREA --- #}

                      </li>
                    {% endfor %}
                  </ul>
                  {# --- Placeholder for the dynamic response --- #}
                  <div class="station-response-box ms-4"></div> 
              </div> {# --- End STATION WRAPPER --- #}
            {% endfor %}
          {% else %}
            <p>{{ meal_name }} menu not available.</p>
          {% endif %}
        </div>
        {% endfor %}
      </div>

    <ul class="nav nav-tabs mt-2" id="menuTabs" role="tablist">
      {% for meal_key, meal_name in {"breakfast":"Breakfast","lunch":"Lunch","dinner":"Dinner"}.items() %}
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="{{ meal_key }}-tab"
                data-bs-toggle="tab" data-bs-target="#{{ meal_key }}"
                type="button" role="tab"
                aria-controls="{{ meal_key }}" aria-selected="false">
          {{ meal_name }}
        </button>
      </li>
      {% endfor %}
    </ul>

    <hr class="thick-hr">

    <div id="chat-section-wrapper">
       </div>

  </div>
</div>

<div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ratingModalLabel" style="color:#333;">Rate Meal</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="color:#333;">
        <p>How would you rate <strong id="modal-meal-name">this meal</strong>?</p>
        {# Ensure stars are easily selectable #}
        <div class="rating-stars-interactive mb-3 text-center" data-current-rating="0"> 
          <i class="bi bi-star rating-star mx-1" data-value="1"></i>
          <i class="bi bi-star rating-star mx-1" data-value="2"></i>
          <i class="bi bi-star rating-star mx-1" data-value="3"></i>
          <i class="bi bi-star rating-star mx-1" data-value="4"></i>
          <i class="bi bi-star rating-star mx-1" data-value="5"></i>
        </div>
        <input type="hidden" id="rating-meal-name-hidden" value="">
        <div id="rating-feedback" class="text-danger small mt-2 text-center"></div> 
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitRatingBtn">Submit Rating</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1"
     aria-labelledby="settingsModalLabel" aria-hidden="true">
    </div>

<div class="text-center personal-toggle-item">
    </div>

<p class="text-center text-secondary disclaimer">...</p>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("DOMContentLoaded event fired. Starting script execution.");

  /* -------- helpers -------- */
  window.setCookie = function(name, value, days) {
    let expires = "";
    if (days) {
      const date = new Date();
      date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
      expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "") + expires + "; path=/";
  };
  
  window.getCookie = function(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
      let c = ca[i];
      while (c.charAt(0) === ' ') c = c.substring(1, c.length);
      if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
  };
  console.log("Helper functions defined.");

  /* -------- clock -------- */
  const timeElement = document.getElementById("current-time");
  console.log("Time element found:", timeElement ? "Yes" : "No");
  
  function displayTime() {
    if (!timeElement) {
      console.error("Time element not found in displayTime function");
      return;
    }
    
    const now = new Date();
    const options = { 
      weekday: 'long', 
      hour: 'numeric', 
      minute: 'numeric', 
      hour12: true 
    };
    
    // Format: "Wednesday, 10:30 AM"
    const formattedTime = now.toLocaleString('en-US', options);
    timeElement.textContent = formattedTime;
    console.log("Updated time to:", formattedTime);
  }
  console.log("displayTime function defined.");

  /* -------- auto‑select meal tab -------- */
  try {
    const now = new Date();
    const hour = now.getHours();
    
    // Set default tab based on time of day
    let activeTab;
    if (hour < 11) {
      activeTab = 'breakfast';
    } else if (hour < 16) {
      activeTab = 'lunch';
    } else {
      activeTab = 'dinner';
    }
    
    // Use Bootstrap's tab API to activate the tab
    console.log(`Setting active tab to ${activeTab} based on time (hour: ${hour})`);
    const tabElement = document.getElementById(`${activeTab}-tab`);
    if (tabElement) {
      const tab = new bootstrap.Tab(tabElement);
      tab.show();
    } else {
      console.warn(`Tab element "${activeTab}-tab" not found`);
    }
  } catch (error) {
    console.error("Error in auto-select meal tab:", error);
  }
  console.log("Tab selection logic executed.");

  /* -------- caret rotation (Revised Logic) -------- */
  const toggleButtons = document.querySelectorAll('.toggle-desc');
  toggleButtons.forEach(button => {
    button.addEventListener('click', function() {
      const caret = this.querySelector('i');
      if (!caret) return;
      
      // Toggle a class directly on click (simple approach)
      caret.classList.toggle('rotate-180');
    });
  });
  
  // Add Bootstrap's collapse events to ensure correct caret state
  document.querySelectorAll('.collapse').forEach(collapseElem => {
    collapseElem.addEventListener('shown.bs.collapse', function() {
      const toggleButton = document.querySelector(`[data-bs-target="#${this.id}"]`);
      if (toggleButton) {
        const caret = toggleButton.querySelector('i');
        if (caret) caret.style.transform = 'rotate(180deg)';
      }
    });
    
    collapseElem.addEventListener('hidden.bs.collapse', function() {
      const toggleButton = document.querySelector(`[data-bs-target="#${this.id}"]`);
      if (toggleButton) {
        const caret = toggleButton.querySelector('i');
        if (caret) caret.style.transform = 'rotate(0deg)';
      }
    });
  });
  console.log("Caret rotation listeners attached.");

  /* -------- settings toggles -------- */
  // Skip implementation for now as it's not critical
  console.log("Settings toggles initialization skipped.");

  /* -------- chat arrow -------- */
  // Skip implementation for now as it's not critical
  console.log("Chat arrow listener skipped.");

  /* -------- chat send -------- */
  // Skip implementation for now as it's not critical
  console.log("Chat send listeners skipped.");

  /* -------- Station‑response logic -------- */
  // Skip implementation for now as it's not critical
  console.log("Station response listeners skipped.");

  // ==================================================
  //           ⭐ RATING SYSTEM LOGIC ⭐
  // ==================================================
  try {
    // Function to check if a meal has been rated by looking in localStorage
    function hasRatedMeal(mealName) {
      return localStorage.getItem(`rated_${mealName}`) === 'true';
    }

    // Function to mark a meal as rated in localStorage
    function markMealAsRated(mealName) {
      try {
        localStorage.setItem(`rated_${mealName}`, 'true');
        return true;
      } catch (e) {
        console.error("Failed to write to localStorage:", e);
        return false;
      }
    }

    const ratingModalElement = document.getElementById('ratingModal');
    const ratingModal = ratingModalElement ? new bootstrap.Modal(ratingModalElement) : null;
    const modalMealNameElement = document.getElementById('modal-meal-name');
    const modalHiddenMealNameInput = document.getElementById('rating-meal-name-hidden');
    const interactiveStarsContainer = ratingModalElement?.querySelector('.rating-stars-interactive');
    const interactiveStars = interactiveStarsContainer?.querySelectorAll('.rating-star'); // NodeList
    const submitRatingBtn = document.getElementById('submitRatingBtn');
    const ratingFeedback = document.getElementById('rating-feedback');
    const ratingEndpoint = '/rate';

    console.log("Rating Elements Check: Modal:", !!ratingModalElement, "Bootstrap Modal Instance:", !!ratingModal, 
                "Stars Container:", !!interactiveStarsContainer, "Stars Found:", interactiveStars ? interactiveStars.length : 0, 
                "Submit Button:", !!submitRatingBtn);

    // Function to update star display in the modal
    function setStars(rating) {
      console.log(`Setting stars to rating: ${rating}`);
      if (!interactiveStarsContainer || !interactiveStars || interactiveStars.length === 0) {
        console.warn("setStars: Could not find stars to update.");
        return;
      }

      const numericRating = parseInt(rating, 10);
      if (isNaN(numericRating)) {
        console.error("setStars: Invalid rating value:", rating);
        return;
      }

      // Store the validated numeric rating in the dataset
      interactiveStarsContainer.dataset.currentRating = numericRating;

      interactiveStars.forEach(star => {
        const starValue = parseInt(star.dataset.value, 10);
        if (isNaN(starValue)) return;

        // Perform comparison and update classes/styles
        if (starValue <= numericRating) {
          // Fill the star
          star.classList.remove('bi-star');
          star.classList.add('bi-star-fill');
          star.style.color = '#ffc107'; // Gold
        } else {
          // Empty the star
          star.classList.remove('bi-star-fill');
          star.classList.add('bi-star');
          star.style.color = '#ccc'; // Grey
        }
      });
    }

    // Function to disable rating buttons for meals that have already been rated
    window.disableRatedButtonsOnLoad = function() {
      console.log("Disabling buttons for previously rated meals...");
      
      // Find all rating buttons on the page
      const ratingButtons = document.querySelectorAll('.rate-meal-btn');
      
      ratingButtons.forEach(button => {
        const mealName = button.getAttribute('data-meal-name');
        
        if (!mealName) {
          console.warn("Found rate button without meal name data attribute");
          return;
        }
        
        // Check if this meal has been rated already
        if (hasRatedMeal(mealName)) {
          console.log(`Disabling rating button for previously rated meal: ${mealName}`);
          
          // Disable the button
          button.disabled = true;
          button.innerHTML = '<i class="bi bi-check-lg"></i> Rated';
          button.title = 'You have already rated this item';
          
          // Update parent meal item to show it's been rated
          const mealItem = button.closest(`[data-meal-name="${mealName}"]`);
          if (mealItem) {
            const starsDisplay = mealItem.querySelector('.stars-display');
            if (starsDisplay) {
              starsDisplay.querySelector('.rating-avg-text').textContent = '(Rated)';
            }
          }
        }
      });
      
      console.log("Finished checking for previously rated meals");
    };

    // Add click event listeners to the rating stars
    if (interactiveStarsContainer && interactiveStars && interactiveStars.length > 0) {
      interactiveStars.forEach(star => {
        star.addEventListener('click', (event) => {
          event.stopPropagation();
          const clickedValue = star.dataset.value;
          console.log(`Star clicked! Value: ${clickedValue}`);

          // Call setStars to update internal state and visual appearance
          setStars(clickedValue);

          // Clear feedback message when a star is clicked
          if (ratingFeedback) ratingFeedback.textContent = '';
        });
      });
      console.log("✅ Attached CLICK listeners to rating stars.");
    } else {
      console.error("❌ Could not attach rating star listeners: Stars not found.");
    }

    // Event listener for opening the rating modal
    if (ratingModalElement && ratingModal) {
      ratingModalElement.addEventListener('show.bs.modal', (event) => {
        console.log("Rating modal opening...");
        const button = event.relatedTarget;
        if (!button) return;
        
        const mealName = button.getAttribute('data-meal-name');
        console.log(`Modal opening for: ${mealName}`);

        if (modalMealNameElement) modalMealNameElement.textContent = mealName;
        if (modalHiddenMealNameInput) modalHiddenMealNameInput.value = mealName;

        // Reset state visually and internally
        setStars(0);
        if (ratingFeedback) ratingFeedback.textContent = '';
        if (submitRatingBtn) submitRatingBtn.disabled = false;

        // Check if rated and adjust UI accordingly
        const isRated = hasRatedMeal(mealName);
        console.log(`Checking if rated: ${isRated}`);

        const elementsToDisable = interactiveStars ? Array.from(interactiveStars) : [];
        if (submitRatingBtn) elementsToDisable.push(submitRatingBtn);

        elementsToDisable.forEach(el => {
          if (!el) return;
          if (isRated) {
            el.style.pointerEvents = 'none';
            el.style.opacity = '0.6';
            if (el.tagName === 'BUTTON') el.disabled = true;
          } else {
            el.style.pointerEvents = 'auto';
            el.style.opacity = '1';
            if (el.tagName === 'BUTTON') el.disabled = false;
          }
        });

        if (isRated && ratingFeedback) {
          ratingFeedback.textContent = 'You have already rated this item.';
        }
      });
      console.log("✅ Attached 'show.bs.modal' listener.");
    } else {
      console.error("❌ Could not attach modal 'show' listener: Modal element or instance missing.");
    }

    // Event listener for submitting the rating
    if (submitRatingBtn && modalHiddenMealNameInput && interactiveStarsContainer) {
      function submitRatingHandler() {
        console.log("Submit button clicked");
        
        const mealName = modalHiddenMealNameInput.value;
        const rating = parseInt(interactiveStarsContainer.dataset.currentRating || '0', 10);
        
        console.log(`Attempting submission for: '${mealName}', Rating: ${rating}`);
        
        // Validation checks
        if (rating === 0) {
          console.warn("Submission aborted: Rating is 0.");
          if (ratingFeedback) ratingFeedback.textContent = 'Please select a star rating (1-5).';
          return;
        }
        
        if (hasRatedMeal(mealName)) {
          console.warn("Submission aborted: Item already rated.");
          if (ratingFeedback) ratingFeedback.textContent = 'You have already rated this item.';
          submitRatingBtn.disabled = true;
          return;
        }
        
        // If validations pass, proceed with submission
        submitRatingBtn.disabled = true;
        if (ratingFeedback) ratingFeedback.textContent = 'Submitting...';
        
        fetch('/rate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ meal_name: mealName, rating: rating }),
        })
        .then(response => {
          if (!response.ok) {
            return response.json().then(data => {
              throw new Error(data.message || `Server error: ${response.status}`);
            });
          }
          return response.json();
        })
        .then(result => {
          console.log("Fetch response:", result);
          
          if (result.status === 'success') {
            console.log("Rating successfully submitted");
            
            // Mark as rated in localStorage
            const stored = markMealAsRated(mealName);
            
            if (!stored) {
              // Handle storage failure
              if (ratingFeedback) {
                ratingFeedback.textContent = 'Rating submitted, but could not save your rating status.';
              }
              return;
            }
            
            // Update all instances of this meal's rating button
            document.querySelectorAll(`.rate-meal-btn[data-meal-name="${mealName}"]`).forEach(originalButton => {
              originalButton.disabled = true;
              originalButton.innerHTML = '<i class="bi bi-check-lg"></i> Rated';
              originalButton.title = 'You have already rated this item';
            });
            
            if (ratingFeedback) ratingFeedback.textContent = 'Rating submitted!';
            
            // Close modal after a brief delay
            setTimeout(() => {
              if (ratingModal) ratingModal.hide();
            }, 1000);
            
          } else {
            throw new Error(result.message || 'Submission failed (unknown reason).');
          }
        })
        .catch(error => {
          console.error('Rating submission error:', error);
          if (ratingFeedback) ratingFeedback.textContent = `Error: ${error.message}. Please try again.`;
          
          // Re-enable button if not already rated
          if (!hasRatedMeal(mealName)) {
            submitRatingBtn.disabled = false;
          }
        });
      }
      
      // Add event listener with the handler function
      submitRatingBtn.addEventListener('click', submitRatingHandler);
      console.log("✅ Attached improved CLICK listener to submit button.");
    } else {
      console.error("❌ Could not attach submit listener: Button, hidden input, or stars container missing.");
    }
    
    // Initialize localStorage check when DOM is loaded
    disableRatedButtonsOnLoad();

  } catch (e) {
    console.error("❌ Error during Rating System setup:", e);
  }

  /* -------- kick things off -------- */
  console.log("Entering final initialization block...");
  try {
    console.log("Calling displayTime() initially...");
    displayTime(); // Initial call
    
    console.log("Setting up interval for displayTime...");
    window.intervalId = setInterval(displayTime, 60000); // Update every minute
    
    console.log("✅ Biola Wizard JS Loaded Successfully ✅");
  } catch (error) {
    console.error("❌ Error during final initialization:", error);
  }
});
</script>

</body>
</html>