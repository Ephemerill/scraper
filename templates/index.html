<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Biola Wizard</title>

    <!-- Bootstrap + icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Local CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />

    <!-- Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon" />
</head>

<body class="bg-dark">

<!-- settings gear -->
<i class="bi bi-gear-fill" id="settings-icon"
   data-bs-toggle="modal" data-bs-target="#settingsModal"
   title="Settings"></i>

<div class="container pt-5">
  <h1 class="text-center text-light mb-4">Biola Wizard</h1>

  <div class="main-content-container">

    <!-- time + weather -->
    <div class="d-flex justify-content-between align-items-center">
      <h2 class="text-secondary" id="current-time">Loading time…</h2>
      <h2 class="text-secondary">
        {% if weather and weather["temperature"] and weather["temperature"][0] %}
            {{ weather["temperature"][0]["temperature"] }}
        {% else %} --°F {% endif %}
      </h2>
    </div>

    <hr class="my-2" style="border-color:#a9a9a9;border-width:2px;">

    <!-- MENU TABS CONTENT -->
    <div class="tab-content mt-3" id="menuTabsContent">
      {% for meal_key, meal_name in {"breakfast":"Breakfast","lunch":"Lunch","dinner":"Dinner"}.items() %}
      <div class="tab-pane fade" id="{{ meal_key }}" role="tabpanel" aria-labelledby="{{ meal_key }}-tab">
        <h2>{{ meal_name }} Menu:</h2>
        {% if menu and menu[meal_key] %}
          {% for station in menu[meal_key] %}
            <h3>{{ station.name | title }}</h3>
            <ul class="list-unstyled">
              {% set sidx = loop.index0 %}
              {% for option in station.options %}
                {% set did = "desc-" ~ meal_key ~ "-" ~ sidx ~ "-" ~ loop.index0 %}
                <li class="mb-1">
                  {{ option.meal | title }}
                  {% if option.description %}
                    <button class="btn btn-link p-0 ms-1 align-baseline toggle-desc"
                            data-bs-toggle="collapse"
                            data-bs-target="#{{ did }}"
                            aria-expanded="false"
                            aria-controls="{{ did }}">
                      <i class="bi bi-chevron-down small"></i>
                    </button>
                    <div class="collapse" id="{{ did }}">
                      <small class="text-muted d-block ps-3">{{ option.description }}</small>
                    </div>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% endfor %}
        {% else %}
          <p>{{ meal_name }} menu not available.</p>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <!-- TAB BAR -->
    <ul class="nav nav-tabs mt-2" id="menuTabs" role="tablist">
      {% for meal_key, meal_name in {"breakfast":"Breakfast","lunch":"Lunch","dinner":"Dinner"}.items() %}
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="{{ meal_key }}-tab"
                data-bs-toggle="tab" data-bs-target="#{{ meal_key }}"
                type="button" role="tab"
                aria-controls="{{ meal_key }}" aria-selected="false">
          {{ meal_name }}
        </button>
      </li>
      {% endfor %}
    </ul>

    <hr class="thick-hr">

    <!-- CHAT SECTION -->
    <div id="chat-section-wrapper">
      <div id="chat-toggle-wrapper">
        <div id="chat-toggle-button" title="Toggle Chat"></div>
        <div id="chat-container">
          <div id="chat-input-area">
            <input type="text" id="user-input" placeholder="Type your message…" />
            <button id="send-button">Send</button>
          </div>
          <div id="chat-messages"></div>
        </div>
      </div>
    </div>

  </div><!-- /main-content-container -->
</div><!-- /container -->

<!-- SETTINGS MODAL -->
<div class="modal fade" id="settingsModal" tabindex="-1"
     aria-labelledby="settingsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="settingsModalLabel" style="color:#333;">Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="color:#333;">
        <!-- chat toggle -->
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" role="switch" id="chatVisibilityToggle" />
          <label class="form-check-label" for="chatVisibilityToggle">Show AI Features</label>
        </div>
        <!-- personal message toggle -->
        <div class="form-check form-switch mt-2">
          <input class="form-check-input" type="checkbox" role="switch" id="personalVisibilityToggle" />
          <label class="form-check-label" for="personalVisibilityToggle">Personal Message</label>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PERSONAL MESSAGE (visible by default) -->
<div class="text-center personal-toggle-item">
  <p class="text-secondary">Thank you for using my website, I really appreciate it. I hope it is able to make your experience a little bit better.</p>
  <p class="text-secondary">The website will always be free and will never have ads, but the server still costs money so any donations would be really helpful.</p>
  <p class="text-secondary">That being said, as a broke college student I understand if you are unable to danate so you can hide this message in the settings tab</p>
  <p class="text-secondary">- Gabriel</p>
  <a href="https://buymeacoffee.com/ephemeril" target="_blank">
    <button class="btn btn-outline-secondary" type="button">Support Me</button>
  </a>
  <p>&nbsp;</p>
</div>

<!-- FOOTER -->
<p class="text-center text-secondary disclaimer">Biola Wizard 1.01 By Gabriel Losh</p>
<p class="text-center text-secondary disclaimer">Menu Data and AI Features May Be Inaccurate</p>
<p class="text-center text-secondary disclaimer">This Tool Was Built With the Assistance of AI</p>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* helpers: cookies */
function setCookie(n,v,d){const t=new Date;t.setTime(t.getTime()+864e5*d),document.cookie=n+"="+v+"; expires="+t.toUTCString()+"; path=/; SameSite=Lax"}
function getCookie(n){const e=n+"=";return document.cookie.split(";").map(c=>c.trim()).find(c=>0===c.indexOf(e))?.substring(e.length)||null}

/* clock */
function displayTime(){const n=new Date,o=n.getMinutes().toString().padStart(2,"0"),t=(n.getHours()%12)||12,e=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][n.getDay()],r=n.getHours()>=12?"PM":"AM";document.getElementById("current-time").textContent=`${e}, ${t}:${o} ${r}`}

/* DOM ready */
document.addEventListener("DOMContentLoaded",()=>{displayTime(),setInterval(displayTime,6e4);
 /* auto‑select meal tab */
(()=>{const n=new Date().getHours(),t=n>=11&&n<16?"lunch":n>=16&&n<20?"dinner":"breakfast",e=document.getElementById(t+"-tab");e&&new bootstrap.Tab(e).show()})();

 /* caret rotation */
document.querySelectorAll(".toggle-desc").forEach(n=>{const t=n.querySelector("i");n.addEventListener("click",()=>{setTimeout(()=>{t.classList.toggle("bi-chevron-down"),t.classList.toggle("bi-chevron-up")},400)})});

 /* toggles ------------------------------------------- */
const chatToggle=document.getElementById("chatVisibilityToggle"),
      personalToggle=document.getElementById("personalVisibilityToggle"),
      chatSection=document.getElementById("chat-section-wrapper"),
      chatArrow=document.getElementById("chat-toggle-button"),
      chatBox=document.getElementById("chat-container");

function applyChat(n){chatSection.classList.toggle("hidden",!n),chatToggle.checked=n,n||(chatArrow.classList.remove("expanded"),chatBox.classList.remove("expanded"))}
function applyPersonal(n){document.querySelectorAll(".personal-toggle-item").forEach(t=>t.classList.toggle("hidden",!n)),personalToggle.checked=n}

/* initial state: chat off, personal on (unless cookie says no) */
applyChat(localStorage.getItem("chatVisible")==="true");
applyPersonal(getCookie("personalMessageVisible")!=="false");

chatToggle.addEventListener("change",e=>{const n=e.target.checked;applyChat(n),localStorage.setItem("chatVisible",n)});
personalToggle.addEventListener("change",e=>{const n=e.target.checked;applyPersonal(n),setCookie("personalMessageVisible",n,365)});

/* chat arrow */
chatArrow.addEventListener("click",()=>{if(chatSection.classList.contains("hidden"))return;chatArrow.classList.toggle("expanded"),chatBox.classList.toggle("expanded"),chatBox.classList.contains("expanded")&&document.getElementById("user-input").focus()});

/* simple message demo */
const sendBtn=document.getElementById("send-button"),userIn=document.getElementById("user-input"),msgBox=document.getElementById("chat-messages"),webhook="https://n8n.biolawizard.com/webhook/ddaed16e-73be-4de6-b3e2-8e246f0765fc";
function addMsg(n,t){const e=document.createElement("div");e.className="message "+t,e.textContent=n,msgBox.prepend(e)}
async function sendMsg(){const n=userIn.value.trim();if(!n)return;addMsg(n,"user-message"),userIn.value="",sendBtn.disabled=!0;try{const t=await fetch(webhook,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:n})}),e=await t.json();addMsg(e.reply??"(no reply)","bot-message")}catch(t){addMsg("Error: "+t,"error-message")}finally{sendBtn.disabled=!1}}
sendBtn.addEventListener("click",sendMsg),userIn.addEventListener("keypress",n=>{"Enter"===n.key&&sendMsg()});
});
</script>
</body>
</html>